<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>细胞呼吸动态描绘演示</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --color-anaerobic: #27ae60; /* 绿 */
            --color-aerobic: #2980b9;   /* 蓝 */
            --color-total: #c0392b;     /* 红 */
            --bg-page: #f0f2f5;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-page);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            color: #333;
        }

        .container {
            max-width: 1100px;
            width: 100%;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.08);
            padding: 30px;
            box-sizing: border-box;
        }

        h2 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
        p.subtitle { text-align: center; color: #7f8c8d; font-size: 0.9em; margin-bottom: 25px; }

        .main-layout {
            display: flex;
            gap: 20px;
        }

        .chart-wrapper {
            flex: 2;
            height: 480px;
            position: relative;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }

        .control-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }

        /* 滑块样式优化 */
        .slider-container label {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 12px;
        }

        input[type=range] {
            width: 100%;
            cursor: pointer;
            height: 8px;
            background: #dfe6e9;
            border-radius: 4px;
            -webkit-appearance: none;
            transition: background 0.2s;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: var(--color-aerobic);
            border: 3px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border-radius: 50%;
            cursor: pointer;
            margin-top: -8px; /* 校准位置 */
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: transparent;
            border-radius: 4px;
        }

        /* 数据状态条 */
        .status-bars {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 10px;
        }
        .bar-item {
            display: flex;
            align-items: center;
            font-size: 0.9em;
        }
        .bar-name { width: 80px; font-weight: 600; }
        .track { flex: 1; height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; }
        .fill { height: 100%; transition: width 0.1s linear; }

        /* 教学卡片 */
        .teach-card {
            background: #fff;
            border-left: 5px solid var(--color-total);
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            font-size: 0.95em;
            line-height: 1.6;
            margin-top: auto; /* 推到底部 */
        }

        @media (max-width: 800px) {
            .main-layout { flex-direction: column; }
            .chart-wrapper { height: 350px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h2>细胞呼吸过程动态模拟</h2>
    <p class="subtitle">向右拖动滑块，观察随着氧气浓度增加，曲线是如何变化的</p>

    <div class="main-layout">
        <div class="chart-wrapper">
            <canvas id="respirationChart"></canvas>
        </div>

        <div class="control-panel">
            <div class="slider-container">
                <label>
                    <span>O₂ 浓度</span>
                    <span style="color:var(--color-aerobic)"><span id="o2Display">0</span>%</span>
                </label>
                <input type="range" id="o2Slider" min="0" max="25" step="0.1" value="0">
                <div style="display:flex; justify-content:space-between; color:#999; font-size:0.8em; margin-top:8px;">
                    <span>0%</span>
                    <span>5% (最低点)</span>
                    <span>10%</span>
                    <span>25%</span>
                </div>
            </div>

            <div class="status-bars">
                <div class="bar-item">
                    <span class="bar-name" style="color:var(--color-anaerobic)">无氧强度</span>
                    <div class="track"><div id="barAna" class="fill" style="background:var(--color-anaerobic); width:100%"></div></div>
                </div>
                <div class="bar-item">
                    <span class="bar-name" style="color:var(--color-aerobic)">有氧强度</span>
                    <div class="track"><div id="barAer" class="fill" style="background:var(--color-aerobic); width:0%"></div></div>
                </div>
                <div class="bar-item">
                    <span class="bar-name" style="color:var(--color-total)">释放总量</span>
                    <div class="track"><div id="barTot" class="fill" style="background:var(--color-total); width:50%"></div></div>
                </div>
            </div>

            <div class="teach-card">
                <strong id="stageName">初始状态</strong>
                <div id="stageDesc">请向右拖动滑块，开始实验...</div>
            </div>
        </div>
    </div>
</div>

<script>
    // ================= 1. 精准数学模型设计 =================
    // 目标：总曲线最低点精确在 x=5.0
    
    // 参数设定：
    // A (无氧起点) = 2.0
    // B (有氧系数) = 5.6 (经过微分计算得出，用于平衡下降趋势)
    // K (米氏常数) = 15 (使得有氧上升较缓，以此在5%处形成谷底)

    const MAX_X = 25;
    const STEP = 0.1;
    
    // 预计算所有数据点（Master Data）
    const masterData = [];

    function calcAnaerobic(x) {
        // 无氧呼吸：在10%处归零
        if(x >= 10) return 0;
        return 2.0 * Math.pow((10 - x) / 10, 2);
    }

    function calcAerobic(x) {
        // 有氧呼吸：米氏方程 V = Vmax * x / (Km + x)
        // 参数调节以确保 x=5 时斜率与无氧下降斜率抵消
        const Vmax = 5.6; 
        const Km = 15;    
        return (Vmax * x) / (Km + x);
    }

    for (let x = 0; x <= MAX_X; x += STEP) {
        // 修正浮点数精度问题
        let safeX = Math.round(x * 10) / 10;
        let ana = calcAnaerobic(safeX);
        let aer = calcAerobic(safeX);
        
        masterData.push({
            x: safeX,
            ana: ana,
            aer: aer,
            tot: ana + aer
        });
    }

    // ================= 2. Chart.js 配置 =================
    const ctx = document.getElementById('respirationChart').getContext('2d');

    // 插件：绘制当前的垂直“笔头”线
    const tracePlugin = {
        id: 'tracePlugin',
        afterDraw: (chart) => {
            // 如果数据为空（x=0时），不画线
            const datasets = chart.data.datasets;
            if (datasets[0].data.length === 0) return;

            // 获取当前绘制数据的最后一个点（即滑块位置）
            const lastPoint = datasets[0].data[datasets[0].data.length - 1];
            if (!lastPoint) return;

            const xVal = lastPoint.x;
            const xScale = chart.scales.x;
            const yScale = chart.scales.y;
            const xPos = xScale.getPixelForValue(xVal);

            const ctx = chart.ctx;
            ctx.save();

            // 绘制垂直引导线
            ctx.beginPath();
            ctx.moveTo(xPos, yScale.top);
            ctx.lineTo(xPos, yScale.bottom);
            ctx.strokeStyle = '#555';
            ctx.lineWidth = 1.5;
            ctx.setLineDash([4, 4]);
            ctx.stroke();

            // 在三个曲线末端画圆点（笔头）
            const idx = datasets[0].data.length - 1;
            
            // 辅助函数：画点
            const drawDot = (datasetIdx, color) => {
                const ds = datasets[datasetIdx];
                if(ds.data.length <= idx) return;
                const val = ds.data[idx].y;
                const yPos = yScale.getPixelForValue(val);

                ctx.beginPath();
                ctx.arc(xPos, yPos, 5, 0, 2 * Math.PI);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
            };

            drawDot(0, '#27ae60'); // Ana
            drawDot(1, '#2980b9'); // Aer
            drawDot(2, '#c0392b'); // Tot

            // 静态标注 R点 (仅当曲线画过5%后显示)
            if (xVal >= 5.0) {
                const minData = masterData.find(p => p.x === 5.0);
                const rX = xScale.getPixelForValue(5.0);
                const rY = yScale.getPixelForValue(minData.tot);
                
                ctx.font = "bold 12px Arial";
                ctx.fillStyle = "#c0392b";
                ctx.textAlign = "center";
                ctx.fillText("↓ 最低点 (5%)", rX, rY + 25);
            }

            ctx.restore();
        }
    };

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [
                {
                    label: '无氧呼吸',
                    data: [], // 初始为空
                    borderColor: '#27ae60',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.4,
                    fill: false
                },
                {
                    label: '有氧呼吸',
                    data: [],
                    borderColor: '#2980b9',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.2,
                    fill: false
                },
                {
                    label: 'CO₂ 释放总量',
                    data: [],
                    borderColor: '#c0392b',
                    borderWidth: 4,
                    pointRadius: 0,
                    tension: 0.4,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { enabled: false }, // 禁用鼠标交互，纯展示
            scales: {
                x: {
                    type: 'linear',
                    min: 0,
                    max: 25, // 固定X轴范围，防止抖动
                    title: { display: true, text: 'O₂ 浓度 (%)', font: {size: 14, weight:'bold'} },
                    grid: { display: false }
                },
                y: {
                    title: { display: true, text: 'CO₂ 释放总量', font: {size: 14, weight:'bold'} },
                    min: 0,
                    suggestedMax: 3.5,
                    ticks: { display: false }, // 隐藏数值
                    grid: { display: true, drawTicks: false }
                }
            },
            plugins: {
                legend: { position: 'top' },
                tooltip: { enabled: false }
            },
            animation: { duration: 0 } // 禁用动画以实现实时跟随
        },
        plugins: [tracePlugin]
    });

    // ================= 3. 交互逻辑 =================
    
    const slider = document.getElementById('o2Slider');
    const o2Display = document.getElementById('o2Display');
    const stageName = document.getElementById('stageName');
    const stageDesc = document.getElementById('stageDesc');
    const barAna = document.getElementById('barAna');
    const barAer = document.getElementById('barAer');
    const barTot = document.getElementById('barTot');

    function updateChart(val) {
        const currentX = parseFloat(val);
        o2Display.innerText = currentX.toFixed(1);

        // 1. 数据截取 (Slicing)
        // 过滤出所有 x <= currentX 的点
        // 如果 currentX == 0, 数组应该为空（除了起始点? 用户要求无曲线，所以给空数组）
        
        let visibleData = [];
        if (currentX > 0) {
            visibleData = masterData.filter(p => p.x <= currentX);
        } else {
            // 0%时，显示为空，或者只显示一个点？
            // 为了符合"无曲线"的要求，给空数组。
            // 但为了进度条显示，我们需要获取x=0的数值
            visibleData = [];
        }

        // 更新 Chart 数据
        chart.data.datasets[0].data = visibleData.map(p => ({x: p.x, y: p.ana}));
        chart.data.datasets[1].data = visibleData.map(p => ({x: p.x, y: p.aer}));
        chart.data.datasets[2].data = visibleData.map(p => ({x: p.x, y: p.tot}));
        
        chart.update();

        // 2. 更新右侧面板数值 (取当前X对应的值)
        // 如果是0，取masterData第一个点
        let currentPoint = masterData.find(p => Math.abs(p.x - currentX) < 0.05) || masterData[0];
        
        // 更新进度条 (归一化显示)
        barAna.style.width = (currentPoint.ana / 2.0 * 100) + '%';
        barAer.style.width = (currentPoint.aer / 3.5 * 100) + '%';
        barTot.style.width = (currentPoint.tot / 3.5 * 100) + '%';

        // 3. 教学文案更新
        if (currentX === 0) {
            stageName.innerText = "准备开始";
            stageDesc.innerHTML = "当前氧气为0。请<strong>向右拖动滑块</strong>，观察曲线如何产生。";
        } else if (currentX > 0 && currentX < 4) {
            stageName.innerText = "无氧呼吸受抑";
            stageDesc.innerHTML = "随着氧气介入，绿色曲线(无氧)急剧下跌。虽然蓝色曲线(有氧)开始生长，但总释放量(红线)在<strong>下降</strong>。";
        } else if (currentX >= 4 && currentX <= 6) {
            stageName.innerText = "最低点 (5%)";
            stageDesc.innerHTML = "注意红线的<strong>谷底</strong>。此时总 CO₂ 释放量最低。这是果蔬储存的最佳氧浓度。";
        } else if (currentX > 6 && currentX < 15) {
            stageName.innerText = "有氧呼吸增强";
            stageDesc.innerHTML = "绿线归零。蓝线和红线同步上升，表明细胞呼吸强度随氧气增加而恢复。";
        } else {
            stageName.innerText = "酶饱和阶段";
            stageDesc.innerHTML = "曲线趋向平直。受限于呼吸酶数量，反应速率达到上限，不再随氧气增加而大幅上升。";
        }
    }

    slider.addEventListener('input', (e) => updateChart(e.target.value));
    
    // 初始化：确保开始时没有线
    updateChart(0);

</script>
</body>
</html>
