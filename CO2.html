<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»†èƒå‘¼å¸ CO2 é‡Šæ”¾æ›²çº¿äº¤äº’æ¼”ç¤º</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --color-anaerobic: #27ae60; /* ç»¿è‰² - æ— æ°§ */
            --color-aerobic: #2980b9;   /* è“è‰² - æœ‰æ°§ */
            --color-total: #c0392b;     /* çº¢è‰² - æ€»é‡ */
            --bg-page: #f4f6f9;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-page);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
        }

        .container {
            max-width: 1100px;
            width: 100%;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            padding: 30px;
            box-sizing: border-box;
        }

        h2 { text-align: center; color: #2c3e50; margin-top: 0; }
        p.subtitle { text-align: center; color: #7f8c8d; font-size: 0.95em; margin-bottom: 30px; }

        .layout-grid {
            display: flex;
            gap: 30px;
        }

        .chart-section {
            flex: 2;
            min-width: 0; /* é˜²æ­¢Chartjsæº¢å‡º */
            height: 480px;
            position: relative;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }

        .control-section {
            flex: 1;
            min-width: 280px;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* æ»‘å—æ§ä»¶ */
        .slider-group label {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 12px;
        }

        input[type=range] {
            width: 100%;
            cursor: pointer;
            height: 8px;
            background: #dcdde1;
            border-radius: 4px;
            -webkit-appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: var(--color-aerobic);
            border: 3px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border-radius: 50%;
            cursor: pointer;
            margin-top: -8px;
        }

        /* çŠ¶æ€è¿›åº¦æ¡ */
        .bars-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .bar-row { display: flex; align-items: center; font-size: 0.9em; }
        .bar-label { width: 85px; font-weight: 600; }
        .bar-track { flex: 1; height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.05s linear; }

        /* æ•™å­¦å¡ç‰‡ */
        .info-box {
            background: #fff;
            border-left: 5px solid var(--color-total);
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            font-size: 0.95em;
            line-height: 1.6;
            margin-top: auto;
        }
        .info-title { display: block; font-weight: bold; margin-bottom: 5px; color: #2c3e50; }

        @media (max-width: 800px) {
            .layout-grid { flex-direction: column; }
            .chart-section { height: 350px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h2>ç»†èƒå‘¼å¸è¿‡ç¨‹åŠ¨æ€æ¨¡æ‹Ÿ</h2>
    <p class="subtitle">æ‹–åŠ¨ä¸‹æ–¹æ»‘å—ï¼Œè§‚å¯Ÿæ°§æ°”æµ“åº¦å¦‚ä½•å½±å“ COâ‚‚ é‡Šæ”¾æ€»é‡</p>

    <div class="layout-grid">
        <div class="chart-section">
            <canvas id="respirationChart"></canvas>
        </div>

        <div class="control-section">
            <div class="slider-group">
                <label>
                    <span>Oâ‚‚ æµ“åº¦</span>
                    <span style="color:var(--color-aerobic)"><span id="o2Value">0</span>%</span>
                </label>
                <input type="range" id="oxygenSlider" min="0" max="25" step="0.1" value="0">
                <div style="display:flex; justify-content:space-between; color:#999; font-size:0.8em; margin-top:8px;">
                    <span>0%</span>
                    <span>5% (æœ€ä½)</span>
                    <span>25%</span>
                </div>
            </div>

            <div class="bars-container">
                <div class="bar-row">
                    <span class="bar-label" style="color:var(--color-anaerobic)">æ— æ°§å¼ºåº¦</span>
                    <div class="bar-track"><div id="barAna" class="bar-fill" style="background:var(--color-anaerobic); width:100%"></div></div>
                </div>
                <div class="bar-row">
                    <span class="bar-label" style="color:var(--color-aerobic)">æœ‰æ°§å¼ºåº¦</span>
                    <div class="bar-track"><div id="barAer" class="bar-fill" style="background:var(--color-aerobic); width:0%"></div></div>
                </div>
                <div class="bar-row">
                    <span class="bar-label" style="color:var(--color-total)">é‡Šæ”¾æ€»é‡</span>
                    <div class="bar-track"><div id="barTot" class="bar-fill" style="background:var(--color-total); width:50%"></div></div>
                </div>
            </div>

            <div class="info-box">
                <span class="info-title" id="stageTitle">åˆå§‹çŠ¶æ€</span>
                <div id="stageDesc">è¯·ç¼“æ…¢å‘å³æ‹–åŠ¨æ»‘å—ï¼Œå¼€å§‹å®éªŒ...</div>
            </div>
        </div>
    </div>
</div>

<script>
    // ================= 1. æ•°å­¦æ¨¡å‹é…ç½® =================
    // ç›®æ ‡ï¼šå¤ç°æ•™ç§‘ä¹¦ä¸Šçš„æ ‡å‡†â€œå¯¹å‹¾â€æ›²çº¿
    // ç‰¹å¾ï¼š
    // â‘  æ— æ°§ï¼šOâ‚‚=0 æ—¶èµ·ç‚¹æ›´é«˜ï¼Œéšåéš Oâ‚‚ å¢åŠ è¿…é€Ÿä¸‹é™ï¼Œåœ¨çº¦ 8.5% å¤„é™ä¸º 0
    // â‘¡ æœ‰æ°§ï¼š0â€“10% ä¿æŒç›´çº¿ y = kxï¼›>10% æ”¹ä¸ºå¹³æ»‘ç¼“æ…¢ä¸Šå‡å¹¶è¶‹äºå¹³å°
    // â‘¢ æ€»é‡ï¼šæ€» COâ‚‚ é‡Šæ”¾é‡ = æ— æ°§ + æœ‰æ°§ï¼Œæœ€ä½ç‚¹ä»åœ¨ 5% Oâ‚‚

    const MAX_X = 25;
    const STEP = 0.1;
    const masterData = [];

    // --- å‚æ•°åŒºï¼ˆå¯ä»¥å¾®è°ƒï¼‰ ---
    // æ— æ°§æ›²çº¿ï¼šæŠ›ç‰©çº¿ä¸‹é™ï¼Œèµ·ç‚¹æŠ¬é«˜åˆ° 4.5ï¼Œåœ¨ 8.5% å·¦å³å½’é›¶
    const ANA_START = 4.5;  // Oâ‚‚=0 æ—¶æ— æ°§ COâ‚‚ é‡Šæ”¾ç›¸å¯¹å€¼
    const ANA_END   = 8.5;  // æ— æ°§åœ¨æ­¤ Oâ‚‚ æµ“åº¦åè¿‘ä¼¼ä¸º 0

    // æœ‰æ°§æ›²çº¿ï¼š
    // 0â€“10%ï¼šy = kx
    // >10%ï¼šä» x=10 å¤„æ¥ä¸Šä¸€æ¡æŒ‡æ•°é¥±å’Œæ›²çº¿ï¼Œä¿è¯å‡½æ•°å€¼å’Œå¯¼æ•°éƒ½è¿ç»­
    const AER_K  = (2 * ANA_START * (1 - 5 / ANA_END)) / ANA_END; // â‰ˆ0.436
    const AER_X0 = 10;   // æ‹ç‚¹èµ·å§‹ï¼š10%
    const AER_TAU = 5;   // æ§åˆ¶ 10% ä¹‹åå˜å¹³çš„é€Ÿåº¦ï¼ˆå¯å¾®è°ƒï¼‰
    const AER_BASE_AT_X0 = AER_K * AER_X0;       // 10% æ—¶åŸç›´çº¿çš„æ•°å€¼
    const AER_B = AER_K * AER_TAU;               // ä»¤å¯¼æ•°åœ¨ 10% ä¹Ÿç­‰äº k

    // è®¡ç®—å‡½æ•°
    function calcAnaerobic(x) {
        if (x >= ANA_END) return 0;
        // æŠ›ç‰©çº¿ä¸‹é™æ¨¡å‹ï¼šx=0 æ—¶ä¸º ANA_STARTï¼›x=ANA_END æ—¶ä¸º 0
        return ANA_START * Math.pow((ANA_END - x) / ANA_END, 2);
    }

    // 0â€“10% å®Œå…¨ä¿æŒåŸå…¬å¼ï¼›>10% æ¢æˆæŒ‡æ•°é¥±å’Œä¸”åœ¨ 10% å¤„ CÂ¹ å¹³æ»‘è¿æ¥
    function calcAerobic(x) {
        if (x <= AER_X0) {
            // ä¿æŒæ—§æ¨¡å‹ï¼šä¸¥æ ¼ y = kx
            return AER_K * x;
        } else {
            // æ–°æ¨¡å‹ï¼šy = y10 + B * (1 - e^{-(x-10)/tau})
            // å…¶ä¸­ B = k * tauï¼Œæ‰€ä»¥åœ¨ x=10 æ—¶å¯¼æ•°ä¹Ÿä¸º k
            const dx = x - AER_X0;
            return AER_BASE_AT_X0 + AER_B * (1 - Math.exp(-dx / AER_TAU));
        }
    }

    // é¢„ç”Ÿæˆæ‰€æœ‰æ•°æ®ç‚¹ï¼Œå¹¶é¡ºä¾¿ç»Ÿè®¡æœ€å¤§å€¼ç”¨äºå³ä¾§è¿›åº¦æ¡å½’ä¸€åŒ–
    let ANA_MAX = 0, AER_MAX = 0, TOT_MAX = 0;

    for (let x = 0; x <= MAX_X; x += STEP) {
        let safeX = Math.round(x * 10) / 10;

        let ana = calcAnaerobic(safeX);
        let aer = calcAerobic(safeX);
        let tot = ana + aer;

        ANA_MAX = Math.max(ANA_MAX, ana);
        AER_MAX = Math.max(AER_MAX, aer);
        TOT_MAX = Math.max(TOT_MAX, tot);

        masterData.push({
            x: safeX,
            ana: ana,
            aer: aer,
            tot: tot
        });
    }

    // ================= 2. å›¾è¡¨åˆå§‹åŒ– (Chart.js) =================
    const ctx = document.getElementById('respirationChart').getContext('2d');

    // è‡ªå®šä¹‰æ’ä»¶ï¼šåŠ¨æ€ç»˜åˆ¶å‚ç›´çº¿å’Œç¬”å¤´åœ†ç‚¹
    const tracePlugin = {
        id: 'tracePlugin',
        afterDraw: (chart) => {
            const datasets = chart.data.datasets;
            // 0% æ—¶æ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œä¸ç»˜åˆ¶ç¬”å¤´
            if (datasets[0].data.length === 0) return;

            const lastDataPoint = datasets[0].data[datasets[0].data.length - 1];
            if (!lastDataPoint) return;

            const xVal = lastDataPoint.x;
            const xScale = chart.scales.x;
            const yScale = chart.scales.y;
            const xPos = xScale.getPixelForValue(xVal);

            const ctx = chart.ctx;
            ctx.save();

            // A. å‚ç›´è™šçº¿å¼•å¯¼
            ctx.beginPath();
            ctx.moveTo(xPos, yScale.top);
            ctx.lineTo(xPos, yScale.bottom);
            ctx.strokeStyle = '#95a5a6';
            ctx.lineWidth = 1.5;
            ctx.setLineDash([5, 5]);
            ctx.stroke();

            // B. ä¸‰æ¡æ›²çº¿æœ«ç«¯çš„åœ†ç‚¹
            const colorMap = ['#27ae60', '#2980b9', '#c0392b']; // ç»¿ã€è“ã€çº¢
            const idx = datasets[0].data.length - 1;

            datasets.forEach((ds, i) => {
                if (ds.data.length <= idx) return;
                const yVal = ds.data[idx].y;
                const yPos = yScale.getPixelForValue(yVal);

                ctx.beginPath();
                ctx.arc(xPos, yPos, 5, 0, 2 * Math.PI);
                ctx.fillStyle = colorMap[i];
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#fff';
                ctx.stroke();
            });

            ctx.restore();
        }
    };

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [
                {
                    label: 'æ— æ°§å‘¼å¸',
                    data: [],
                    borderColor: '#27ae60',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.4,
                    fill: false
                },
                {
                    label: 'æœ‰æ°§å‘¼å¸',
                    data: [],
                    borderColor: '#2980b9',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1,
                    fill: false
                },
                {
                    label: 'CO2 é‡Šæ”¾æ€»é‡',
                    data: [],
                    borderColor: '#c0392b',
                    borderWidth: 4,
                    pointRadius: 0,
                    tension: 0.4,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { enabled: false },
            scales: {
                x: {
                    type: 'linear',
                    min: 0,
                    max: 25,
                    title: { display: true, text: 'Oâ‚‚ æµ“åº¦ (%)', font: {size: 14, weight:'bold'} },
                    grid: { display: false }
                },
                y: {
                    title: { display: true, text: 'CO2 é‡Šæ”¾ç›¸å¯¹å€¼', font: {size: 14, weight:'bold'} },
                    min: 0,
                    suggestedMax: 7.5,
                    ticks: { display: false },
                    grid: { display: true, drawTicks: false }
                }
            },
            plugins: {
                legend: { position: 'top' },
                tooltip: { enabled: false }
            },
            animation: { duration: 0 }
        },
        plugins: [tracePlugin]
    });

    // ================= 3. äº¤äº’æ§åˆ¶é€»è¾‘ =================

    const slider = document.getElementById('oxygenSlider');
    const o2ValueDisplay = document.getElementById('o2Value');
    const stageTitle = document.getElementById('stageTitle');
    const stageDesc = document.getElementById('stageDesc');
    const barAna = document.getElementById('barAna');
    const barAer = document.getElementById('barAer');
    const barTot = document.getElementById('barTot');

    function updateSystem(val) {
        const currentX = parseFloat(val);
        o2ValueDisplay.innerText = currentX.toFixed(1);

        // --- A. æ›´æ–°å›¾è¡¨æ•°æ® ---
        let visibleData = [];
        if (currentX > 0) {
            visibleData = masterData.filter(p => p.x <= currentX);
        }

        chart.data.datasets[0].data = visibleData.map(p => ({x: p.x, y: p.ana}));
        chart.data.datasets[1].data = visibleData.map(p => ({x: p.x, y: p.aer}));
        chart.data.datasets[2].data = visibleData.map(p => ({x: p.x, y: p.tot}));

        chart.update();

        // --- B. æ›´æ–°å³ä¾§é¢æ¿è¿›åº¦æ¡ï¼ˆæŒ‰æœ€å¤§å€¼å½’ä¸€åŒ–ï¼‰ ---
        let currentPoint = masterData.find(p => Math.abs(p.x - currentX) < 0.05) || masterData[0];

        barAna.style.width = (ANA_MAX === 0 ? 0 : currentPoint.ana / ANA_MAX * 100) + '%';
        barAer.style.width = (AER_MAX === 0 ? 0 : currentPoint.aer / AER_MAX * 100) + '%';
        barTot.style.width = (TOT_MAX === 0 ? 0 : currentPoint.tot / TOT_MAX * 100) + '%';

        // --- C. æ•™å­¦æ–‡æ¡ˆåŒºé—´åˆ’åˆ†ä¿æŒä¸å˜ï¼ˆå¦‚éœ€ï¼Œå¯å†ç»†åˆ† 10% ä¹‹åçš„ä¸€æ®µè¯´æ˜ï¼‰ ---
        if (currentX === 0) {
            stageTitle.innerText = "å‡†å¤‡é˜¶æ®µ";
            stageDesc.innerHTML = "å½“å‰æ°§æ°”æµ“åº¦ä¸º 0%ã€‚æ­¤æ—¶åªæœ‰æ— æ°§å‘¼å¸ï¼ŒCOâ‚‚ é‡Šæ”¾é‡è¾ƒé«˜ã€‚è¯·<strong>å‘å³æ‹–åŠ¨æ»‘å—</strong>ï¼Œè§‚å¯Ÿä¸‰æ¡æ›²çº¿çš„åŠ¨æ€ç”Ÿæˆè¿‡ç¨‹ã€‚";
        } else if (currentX > 0 && currentX < 4.5) {
            stageTitle.innerText = "ğŸ“‰ æ€¥å‰§ä¸‹é™ (å¯¹å‹¾å·¦ç¿¼)";
            stageDesc.innerHTML = "æ°§æ°”æµ“åº¦å‡é«˜æŠ‘åˆ¶äº†æ— æ°§å‘¼å¸ï¼Œä½¿æ— æ°§äº§ç”Ÿçš„ COâ‚‚ æ€¥å‰§ä¸‹é™ã€‚æ­¤æ—¶æœ‰æ°§å‘¼å¸è™½åœ¨å¢åŠ ï¼Œä½†ä¸è¶³ä»¥æŠµæ¶ˆä¸‹é™ï¼Œæ€» COâ‚‚ ä»åœ¨<strong>å¿«é€Ÿå‡å°</strong>ã€‚";
        } else if (currentX >= 4.5 && currentX <= 5.5) {
            stageTitle.innerText = "ğŸ¯ æœ€ä½ç‚¹è½¬æŠ˜ (5%)";
            stageDesc.innerHTML = "<strong>å…³é”®æ—¶åˆ»ï¼š</strong>çº¢çº¿ï¼ˆæ€» COâ‚‚ï¼‰åœ¨çº¦ 5% æ—¶è¾¾åˆ°è°·åº•ã€‚æœ‰æ°§å’Œæ— æ°§ä¸¤æ¡æ›²çº¿æ­¤æ—¶æ­£å¥½â€œæ­¤æ¶ˆå½¼é•¿â€ï¼Œæ˜¯æœè”¬å‚¨å­˜çš„æœ€ä½³ç¯å¢ƒã€‚";
        } else if (currentX > 5.5 && currentX < 10) {
            stageTitle.innerText = "ğŸ“ˆ å¿«é€Ÿå›å‡ (è¿‘ä¼¼çº¿æ€§)";
            stageDesc.innerHTML = "æ— æ°§å‘¼å¸å·²å‡ ä¹åœæ­¢ï¼Œæœ‰æ°§å‘¼å¸éšæ°§æ°”å¢åŠ å‘ˆè¿‘ä¼¼ç›´çº¿çš„<strong>å¿«é€Ÿå¢å¼º</strong>ï¼Œæ€» COâ‚‚ é‡Šæ”¾é‡å¤§å¹…å›å‡ã€‚";
        } else {
            stageTitle.innerText = "ğŸ›‘ é«˜æ°§ç¼“æ…¢ä¸Šå‡é˜¶æ®µ";
            stageDesc.innerHTML = "å½“æ°§æ°”æµ“åº¦è¶…è¿‡ 10% åï¼Œæœ‰æ°§å‘¼å¸é€Ÿç‡è™½ç„¶ç»§ç»­<strong>ç¼“æ…¢ä¸Šå‡</strong>ï¼Œä½†ç”±äºé…¶ä¿ƒååº”é€æ¸æ¥è¿‘æœ€é«˜é€Ÿç‡ï¼Œæ›²çº¿åœ¨é«˜æ°§åŒºé€æ­¥å˜å¾—å¹³ç¼“ã€‚";
        }

        if (window.MathJax) MathJax.typesetPromise([stageDesc]);
    }

    slider.addEventListener('input', (e) => updateSystem(e.target.value));

    // åˆå§‹åŒ–
    updateSystem(0);
</script>





</body>
</html>
